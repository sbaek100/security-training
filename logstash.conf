# 입력부 - 여러 소스에서 로그 수집
input {
  # Filebeat에서 오는 로그
  beats {
    port => 5044
  }

  # TCP로 직접 들어오는 로그 (테스트용)
  tcp {
    port => 50000
    codec => json_lines
  }

  # 시스템 로그 (syslog)
  udp {
    port => 514
    codec => plain
  }
}

# 처리부 - 로그 데이터 정리 및 분석
filter {
  # 기본적인 필드 추가
  mutate {
    add_field => { "received_at" => "%{@timestamp}" }
    add_field => { "server_name" => "security-server" }
  }

  # 타임스탬프 파싱
  if [fields][log_type] == "syslog" {
    grok {
      match => {
        "message" => "%{SYSLOGTIMESTAMP:timestamp} %{IPORHOST:host} %{DATA:program}(?:\[%{POSINT:pid}\])?: %{GREEDYDATA:log_message}"
      }
    }
  }
}

# 출력부 - Elasticsearch에 저장
output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    # 날짜별 인덱스 생성
    index => "security-logs-%{+YYYY.MM.dd}"
  }

  # 콘솔 출력 (디버깅용)
  stdout {
    codec => rubydebug
  }
}
